package protocols;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.math.BigInteger;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

import fileManager.Chunk;
import peer.Peer;

public class ReadFile implements Runnable {

	private File file;
	private int replication;
	
	public ReadFile(File f, int replication) {
		this.file = f;
		this.replication = replication;
	}
	
	public void run() {
		
		int chunkNo = 1;
		byte[] buffer = new byte[Constants.CHUNKSIZE];
		
		try {
			
			BufferedInputStream bufferInput = new BufferedInputStream(new FileInputStream(file));
			MessageDigest messageDigest = MessageDigest.getInstance("SHA-256");
			messageDigest.update((file.getName()+Long.toString(file.lastModified())).getBytes());
			String fileIDbin = new String(messageDigest.digest());
			String fileID = String.format("%040x", new BigInteger(1, fileIDbin.getBytes()));
			Peer.addToTranslations(file.getName(), fileID);
			
			@SuppressWarnings("unused")
			int bytesRead;
			
			//
			


			int FILE_SIZE = (int) file.length();
			int CHUNK_SIZE = Constants.CHUNKSIZE;
			byte[] temporary = null;
			  
			int totalBytesRead = 0;
			
			while ( totalBytesRead < FILE_SIZE ) {
				
				int bytesRemaining = FILE_SIZE - totalBytesRead;
			    if ( bytesRemaining < Constants.CHUNKSIZE) {
			    	CHUNK_SIZE = bytesRemaining;
			    }
			    temporary = new byte[Constants.CHUNKSIZE];
			    int bytesRead1 = bufferInput.read(temporary, 0, CHUNK_SIZE);
			    
			    Chunk chunk = new Chunk(fileID, chunkNo, temporary, replication);
				Peer.addBackup(chunk,null);
				
				Runnable run=new ChunkBackup(chunk);
				new Thread(run).start();
			    
			    if (bytesRead1 > 0) {
			    	totalBytesRead += bytesRead1;
			    	chunkNo++;
			    }
			}

			
			/*
			while ((bytesRead = bufferInput.read(buffer)) > 0) {
				
				Chunk chunk = new Chunk(fileID, chunkNo, buffer, replication);
				Peer.addBackup(chunk,null);
				
				Runnable run=new ChunkBackup(chunk);
				new Thread(run).start();
				
				chunkNo++;
			}*/
			
			bufferInput.close();
			
		} catch (NoSuchAlgorithmException | IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}

}
